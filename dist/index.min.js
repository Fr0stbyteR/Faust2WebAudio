!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Faust2WebAudio=e():t.Faust2WebAudio=e()}(window,(function(){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=4)}([function(t,e,s){t.exports=s(3)},function(t,e){function s(t,e,s,i,a,r,o){try{var n=t[r](o),u=n.value}catch(t){return void s(t)}n.done?e(u):Promise.resolve(u).then(i,a)}t.exports=function(t){return function(){var e=this,i=arguments;return new Promise((function(a,r){var o=t.apply(e,i);function n(t){s(o,a,r,n,u,"next",t)}function u(t){s(o,a,r,n,u,"throw",t)}n(void 0)}))}}},function(t,e){t.exports=function(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}},function(t,e,s){var i=function(t){"use strict";var e=Object.prototype,s=e.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",r=i.asyncIterator||"@@asyncIterator",o=i.toStringTag||"@@toStringTag";function n(t,e,s,i){var a=e&&e.prototype instanceof p?e:p,r=Object.create(a.prototype),o=new M(i||[]);return r._invoke=function(t,e,s){var i="suspendedStart";return function(a,r){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===a)throw r;return x()}for(s.method=a,s.arg=r;;){var o=s.delegate;if(o){var n=y(o,s);if(n){if(n===h)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if("suspendedStart"===i)throw i="completed",s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);i="executing";var p=u(t,e,s);if("normal"===p.type){if(i=s.done?"completed":"suspendedYield",p.arg===h)continue;return{value:p.arg,done:s.done}}"throw"===p.type&&(i="completed",s.method="throw",s.arg=p.arg)}}}(t,s,o),r}function u(t,e,s){try{return{type:"normal",arg:t.call(e,s)}}catch(t){return{type:"throw",arg:t}}}t.wrap=n;var h={};function p(){}function c(){}function l(){}var f={};f[a]=function(){return this};var d=Object.getPrototypeOf,m=d&&d(d(w([])));m&&m!==e&&s.call(m,a)&&(f=m);var b=l.prototype=p.prototype=Object.create(f);function v(t){["next","throw","return"].forEach((function(e){t[e]=function(t){return this._invoke(e,t)}}))}function g(t){var e;this._invoke=function(i,a){function r(){return new Promise((function(e,r){!function e(i,a,r,o){var n=u(t[i],t,a);if("throw"!==n.type){var h=n.arg,p=h.value;return p&&"object"==typeof p&&s.call(p,"__await")?Promise.resolve(p.__await).then((function(t){e("next",t,r,o)}),(function(t){e("throw",t,r,o)})):Promise.resolve(p).then((function(t){h.value=t,r(h)}),(function(t){return e("throw",t,r,o)}))}o(n.arg)}(i,a,e,r)}))}return e=e?e.then(r,r):r()}}function y(t,e){var s=t.iterator[e.method];if(void 0===s){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,y(t,e),"throw"===e.method))return h;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var i=u(s,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,h;var a=i.arg;return a?a.done?(e[t.resultName]=a.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,h):a:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,h)}function $(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function A(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function M(t){this.tryEntries=[{tryLoc:"root"}],t.forEach($,this),this.reset(!0)}function w(t){if(t){var e=t[a];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,r=function e(){for(;++i<t.length;)if(s.call(t,i))return e.value=t[i],e.done=!1,e;return e.value=void 0,e.done=!0,e};return r.next=r}}return{next:x}}function x(){return{value:void 0,done:!0}}return c.prototype=b.constructor=l,l.constructor=c,l[o]=c.displayName="GeneratorFunction",t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===c||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,o in t||(t[o]="GeneratorFunction")),t.prototype=Object.create(b),t},t.awrap=function(t){return{__await:t}},v(g.prototype),g.prototype[r]=function(){return this},t.AsyncIterator=g,t.async=function(e,s,i,a){var r=new g(n(e,s,i,a));return t.isGeneratorFunction(s)?r:r.next().then((function(t){return t.done?t.value:r.next()}))},v(b),b[o]="Generator",b[a]=function(){return this},b.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var s in t)e.push(s);return e.reverse(),function s(){for(;e.length;){var i=e.pop();if(i in t)return s.value=i,s.done=!1,s}return s.done=!0,s}},t.values=w,M.prototype={constructor:M,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(A),!t)for(var e in this)"t"===e.charAt(0)&&s.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function i(s,i){return o.type="throw",o.arg=t,e.next=s,i&&(e.method="next",e.arg=void 0),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a],o=r.completion;if("root"===r.tryLoc)return i("end");if(r.tryLoc<=this.prev){var n=s.call(r,"catchLoc"),u=s.call(r,"finallyLoc");if(n&&u){if(this.prev<r.catchLoc)return i(r.catchLoc,!0);if(this.prev<r.finallyLoc)return i(r.finallyLoc)}else if(n){if(this.prev<r.catchLoc)return i(r.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return i(r.finallyLoc)}}}},abrupt:function(t,e){for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i];if(a.tryLoc<=this.prev&&s.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var r=a;break}}r&&("break"===t||"continue"===t)&&r.tryLoc<=e&&e<=r.finallyLoc&&(r=null);var o=r?r.completion:{};return o.type=t,o.arg=e,r?(this.method="next",this.next=r.finallyLoc,h):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),h},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var s=this.tryEntries[e];if(s.finallyLoc===t)return this.complete(s.completion,s.afterLoc),A(s),h}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var s=this.tryEntries[e];if(s.tryLoc===t){var i=s.completion;if("throw"===i.type){var a=i.arg;A(s)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,s){return this.delegate={iterator:w(t),resultName:e,nextLoc:s},"next"===this.method&&(this.arg=void 0),h}},t}(t.exports);try{regeneratorRuntime=i}catch(t){Function("r","regeneratorRuntime = r")(i)}},function(t,e,s){"use strict";s.r(e);var i=s(2),a=s.n(i),r=s(0),o=s.n(r),n=s(1),u=s.n(n);class h{static hash(t,e){const s=Object.assign({msgFormat:"string",outFormat:"hex"},e);switch(s.msgFormat){default:case"string":t=function(t){try{return(new TextEncoder).encode(t,"utf-8").reduce((t,e)=>t+String.fromCharCode(e),"")}catch(e){return unescape(encodeURIComponent(t))}}(t);break;case"hex-bytes":t=function(t){const e=t.replace(" ","");return""==e?"":e.match(/.{2}/g).map(t=>String.fromCharCode(parseInt(t,16))).join("")}(t)}const i=[1518500249,1859775393,2400959708,3395469782],a=[1732584193,4023233417,2562383102,271733878,3285377520],r=(t+=String.fromCharCode(128)).length/4+2,o=Math.ceil(r/16),n=new Array(o);for(let e=0;e<o;e++){n[e]=new Array(16);for(let s=0;s<16;s++)n[e][s]=t.charCodeAt(64*e+4*s+0)<<24|t.charCodeAt(64*e+4*s+1)<<16|t.charCodeAt(64*e+4*s+2)<<8|t.charCodeAt(64*e+4*s+3)<<0}n[o-1][14]=8*(t.length-1)/Math.pow(2,32),n[o-1][14]=Math.floor(n[o-1][14]),n[o-1][15]=8*(t.length-1)&4294967295;for(let t=0;t<o;t++){const e=new Array(80);for(let s=0;s<16;s++)e[s]=n[t][s];for(let t=16;t<80;t++)e[t]=h.ROTL(e[t-3]^e[t-8]^e[t-14]^e[t-16],1);let s=a[0],r=a[1],o=a[2],u=a[3],p=a[4];for(let t=0;t<80;t++){const a=Math.floor(t/20),n=h.ROTL(s,5)+h.f(a,r,o,u)+p+i[a]+e[t]>>>0;p=u,u=o,o=h.ROTL(r,30)>>>0,r=s,s=n}a[0]=a[0]+s>>>0,a[1]=a[1]+r>>>0,a[2]=a[2]+o>>>0,a[3]=a[3]+u>>>0,a[4]=a[4]+p>>>0}for(let t=0;t<a.length;t++)a[t]=("00000000"+a[t].toString(16)).slice(-8);const u="hex-w"==s.outFormat?" ":"";return a.join(u)}static f(t,e,s,i){switch(t){case 0:return e&s^~e&i;case 1:return e^s^i;case 2:return e&s^e&i^s&i;case 3:return e^s^i}}static ROTL(t,e){return t<<e|t>>>32-e}}var p=h;class c{static fetchModule(t){return u()(o.a.mark((function e(){var s,i,a,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s={},window.exports=s,window.module={exports:s},e.next=5,import(t);case 5:if(i=e.sent,1!==(a=Object.keys(i)).length||"default"!==a[0]){e.next=9;break}return e.abrupt("return",i.default);case 9:if(!a.length){e.next=11;break}return e.abrupt("return",i);case 11:return r=window.module.exports,delete window.exports,delete window.module,e.abrupt("return",r);case 15:case"end":return e.stop()}}),e)})))()}static load(t,e,s){var i=(t,i)=>({"libfaust-wasm.wasm":e,"libfaust-wasm.data":s}[t]||i+t);return this.fetchModule(t).then(t=>{var e=t({locateFile:i});return e.then=t=>{if(delete e.then,e.calledRun)t(e);else{var s=e.onRuntimeInitialized;e.onRuntimeInitialized=()=>{s&&s(),t(e)}}return e},e.lengthBytesUTF8=t=>{for(var e=0,s=0;s<t.length;++s){var i=t.charCodeAt(s);i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&t.charCodeAt(++s)),i<=127?++e:e+=i<=2047?2:i<=65535?3:i<=2097151?4:i<=67108863?5:6}return e},e})}}var l=t=>t?String.fromCharCode.apply(null,new Uint8Array(t)):null,f=t=>{if(!t)return null;for(var e=new ArrayBuffer(t.length),s=new Uint8Array(e),i=0,a=t.length;i<a;i++)s[i]=t.charCodeAt(i);return e},d=new WebAssembly.Module(((t,e)=>{if("function"==typeof window.atob)return f(atob(t));for(var s,i,a,r=t.replace(/[^A-Za-z0-9+/]/g,""),o=r.length,n=e?Math.ceil((3*o+1>>2)/e)*e:3*o+1>>2,u=new Uint8Array(n),h=0,p=0,c=0;c<o;c++)if(i=3&c,h|=((a=r.charCodeAt(c))>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:43===a?62:47===a?63:0)<<18-6*i,3===i||o-c==1){for(s=0;s<3&&p<n;s++,p++)u[p]=h>>>(16>>>s&24)&255;h=0}return u.buffer})("data:application/wasm;base64,AGFzbQEAAAABj4CAgAACYAN/f38AYAR/f39/AX0CkoCAgAABBm1lbW9yeQZtZW1vcnkCAAIDg4CAgAACAAEHmoCAgAACC2NsZWFyT3V0cHV0AAAIbWl4Vm9pY2UAAQqKgoCAAALigICAAAEDfwJAQQAhBQNAAkAgAiAFQQJ0aigCACEDQQAhBANAAkAgAyAEQQJ0akMAAAAAOAIAIARBAWohBCAEIABIBEAMAgUMAQsACwsgBUEBaiEFIAUgAUgEQAwCBQwBCwALCwsLnYGAgAACBH8DfQJ9QQAhB0MAAAAAIQgDQAJAQQAhBiACIAdBAnRqKAIAIQQgAyAHQQJ0aigCACEFA0ACQCAEIAZBAnRqKgIAIQkgCCAJi5chCCAFIAZBAnRqKgIAIQogBSAGQQJ0aiAKIAmSOAIAIAZBAWohBiAGIABIBEAMAgUMAQsACwsgB0EBaiEHIAcgAUgEQAwCBQwBCwALCyAIDwsL".split(",")[1])),m=t=>440*Math.pow(2,(t-69)/12),b=(t,e,s,i,a)=>(t-e)/(s-e)*(a-i)+i,v=()=>{var t=(e,s)=>{if("object"!=typeof e)return!1;if(e.address)return e.address===s;for(var i in e)if(t(e[i],s))return!0;return!1};return t},g=(t,e)=>({env:{memory:t?e:void 0,memoryBase:0,tableBase:0,_abs:Math.abs,_acosf:Math.acos,_asinf:Math.asin,_atanf:Math.atan,_atan2f:Math.atan2,_ceilf:Math.ceil,_cosf:Math.cos,_expf:Math.exp,_floorf:Math.floor,_fmodf:(t,e)=>t%e,_logf:Math.log,_log10f:Math.log10,_max_f:Math.max,_min_f:Math.min,_remainderf:(t,e)=>t-Math.round(t/e)*e,_powf:Math.pow,_roundf:Math.fround,_sinf:Math.sin,_sqrtf:Math.sqrt,_tanf:Math.tan,_acoshf:Math.acosh,_asinhf:Math.asinh,_atanhf:Math.atanh,_coshf:Math.cosh,_sinhf:Math.sinh,_tanhf:Math.tanh,_acos:Math.acos,_asin:Math.asin,_atan:Math.atan,_atan2:Math.atan2,_ceil:Math.ceil,_cos:Math.cos,_exp:Math.exp,_floor:Math.floor,_fmod:(t,e)=>t%e,_log:Math.log,_log10:Math.log10,_max_:Math.max,_min_:Math.min,_remainder:(t,e)=>t-Math.round(t/e)*e,_pow:Math.pow,_round:Math.fround,_sin:Math.sin,_sqrt:Math.sqrt,_tan:Math.tan,_acosh:Math.acosh,_asinh:Math.asinh,_atanh:Math.atanh,_cosh:Math.cosh,_sinh:Math.sinh,_tanh:Math.tanh,table:new WebAssembly.Table({initial:0,element:"anyfunc"})}}),y=(t,e,s,i)=>{var a=Math.max(4,t),r=(t=>{for(var e=65536;e<t;)e*=2;return e})((s?s.size:0)+e.size*a+(e.inputs+2*e.outputs)*(4+4*i))/65536;return r=Math.max(2,r),new WebAssembly.Memory({initial:r,maximum:r})},$=t=>{var e=[],s=function(s){var i=t[s];Array.isArray(i)?i.forEach(t=>e.push(s,t)):"number"==typeof i?e.push(s,i.toString()):e.push(s,i)};for(var i in t)s(i);return e};function A(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}class M{constructor(t){this.faust=void 0,this.faust=t}initNode(t,e,s,i,r,o,n,u,h){var p,c=t.dspMeta,l=c.inputs,f=c.outputs;try{p=r.createScriptProcessor(o,l,f)}catch(t){throw this.faust.error("Error in createScriptProcessor: "+t.message),t}if(p.destroyed=!1,p.voices=u,p.dspMeta=c,p.outputHandler=null,p.computeHandler=null,p.$ins=null,p.$outs=null,p.dspInChannnels=[],p.dspOutChannnels=[],p.fPitchwheelLabel=[],p.fCtrlLabel=new Array(128).fill(null).map(()=>[]),p.numIn=l,p.numOut=f,this.faust.log(p.numIn),this.faust.log(p.numOut),p.ptrSize=4,p.sampleSize=4,p.factory=e.exports,p.HEAP=p.voices?n.buffer:p.factory.memory.buffer,p.HEAP32=new Int32Array(p.HEAP),p.HEAPF32=new Float32Array(p.HEAP),this.faust.log(p.HEAP),this.faust.log(p.HEAP32),this.faust.log(p.HEAPF32),p.outputsTimer=5,p.outputsItems=[],p.inputsItems=[],p.$audioHeap=p.voices?0:p.dspMeta.size,p.$$audioHeapInputs=p.$audioHeap,p.$$audioHeapOutputs=p.$$audioHeapInputs+p.numIn*p.ptrSize,p.voices?(p.$$audioHeapMixing=p.$$audioHeapOutputs+p.numOut*p.ptrSize,p.$audioHeapInputs=p.$$audioHeapMixing+p.numOut*p.ptrSize,p.$audioHeapOutputs=p.$audioHeapInputs+p.numIn*p.bufferSize*p.sampleSize,p.$audioHeapMixing=p.$audioHeapOutputs+p.numOut*p.bufferSize*p.sampleSize,p.$dsp=p.$audioHeapMixing+p.numOut*p.bufferSize*p.sampleSize):(p.$audioHeapInputs=p.$$audioHeapOutputs+p.numOut*p.ptrSize,p.$audioHeapOutputs=p.$audioHeapInputs+p.numIn*p.bufferSize*p.sampleSize,p.$dsp=0),p.voices){p.effectMeta=t.effectMeta,p.$mixing=null,p.fFreqLabel$=[],p.fGateLabel$=[],p.fGainLabel$=[],p.fDate=0,p.mixer=i.exports,p.effect=s?s.exports:null,this.faust.log(p.mixer),this.faust.log(p.factory),this.faust.log(p.effect),p.dspVoices$=[],p.dspVoicesState=[],p.dspVoicesLevel=[],p.dspVoicesDate=[],p.kActiveVoice=0,p.kFreeVoice=-1,p.kReleaseVoice=-2,p.kNoVoice=-3;for(var d=0;d<p.voices;d++)p.dspVoices$[d]=p.$dsp+d*p.dspMeta.size,p.dspVoicesState[d]=p.kFreeVoice,p.dspVoicesLevel[d]=0,p.dspVoicesDate[d]=0;p.$effect=p.dspVoices$[p.voices-1]+p.dspMeta.size}p.pathTable$={},p.$buffer=0,p.cachedEvents=[],p.plotHandler=h,p.updateOutputs=()=>{p.outputsItems.length>0&&p.outputHandler&&0==p.outputsTimer--&&(p.outputsTimer=5,p.outputsItems.forEach(t=>p.outputHandler(t,p.factory.getParamValue(p.$dsp,p.pathTable$[t]))))},p.parseUI=t=>t.forEach(t=>p.parseGroup(t)),p.parseGroup=t=>t.items?p.parseItems(t.items):null,p.parseItems=t=>t.forEach(t=>p.parseItem(t)),p.parseItem=t=>{if("vgroup"===t.type||"hgroup"===t.type||"tgroup"===t.type)p.parseItems(t.items);else if("hbargraph"===t.type||"vbargraph"===t.type)p.outputsItems.push(t.address),p.pathTable$[t.address]=t.index;else if("vslider"===t.type||"hslider"===t.type||"button"===t.type||"checkbox"===t.type||"nentry"===t.type){if(p.inputsItems.push(t.address),p.pathTable$[t.address]=t.index,!t.meta)return;t.meta.forEach(e=>{var s=e.midi;if(s){var i=s.trim();if("pitchwheel"===i)p.fPitchwheelLabel.push({path:t.address,min:t.min,max:t.max});else{var a=i.match(/^ctrl\s(\d+)/);if(!a)return;p.fCtrlLabel[parseInt(a[1])].push({path:t.address,min:t.min,max:t.max})}}})}},p.voices&&(p.getPlayingVoice=t=>{for(var e=p.kNoVoice,s=Number.MAX_VALUE,i=0;i<p.voices;i++)p.dspVoicesState[i]===t&&p.dspVoicesDate[i]<s&&(s=p.dspVoicesDate[i],e=i);return e},p.allocVoice=t=>(p.factory.instanceClear(p.dspVoices$[t]),p.dspVoicesDate[t]=p.fDate++,p.dspVoicesState[t]=p.kActiveVoice,t),p.getFreeVoice=()=>{for(var t=0;t<p.voices;t++)if(p.dspVoicesState[t]===p.kFreeVoice)return p.allocVoice(t);for(var e=p.kNoVoice,s=p.kNoVoice,i=Number.MAX_VALUE,a=Number.MAX_VALUE,r=0;r<p.voices;r++)p.dspVoicesState[r]===p.kReleaseVoice?p.dspVoicesDate[r]<i&&(i=p.dspVoicesDate[r],e=r):p.dspVoicesDate[r]<a&&(a=p.dspVoicesDate[r],s=r);return i!==Number.MAX_VALUE?(this.faust.log("Steal release voice : voice_date = ".concat(p.dspVoicesDate[e]," cur_date = ").concat(p.fDate," voice = ").concat(e)),p.allocVoice(e)):a!==Number.MAX_VALUE?(this.faust.log("Steal playing voice : voice_date = ".concat(p.dspVoicesDate[s]," cur_date = ").concat(p.fDate," voice = ").concat(s)),p.allocVoice(s)):p.kNoVoice},p.keyOn=(t,e,s)=>{p.cachedEvents.push({type:"keyOn",data:[t,e,s]});var i=p.getFreeVoice();this.faust.log("keyOn voice "+i),p.fFreqLabel$.forEach(t=>p.factory.setParamValue(p.dspVoices$[i],t,m(e))),p.fGateLabel$.forEach(t=>p.factory.setParamValue(p.dspVoices$[i],t,1)),p.fGainLabel$.forEach(t=>p.factory.setParamValue(p.dspVoices$[i],t,s/127)),p.dspVoicesState[i]=e},p.keyOff=(t,e,s)=>{p.cachedEvents.push({type:"keyOff",data:[t,e,s]});var i=p.getPlayingVoice(e);return i===p.kNoVoice?this.faust.log("Playing voice not found..."):(p.fGateLabel$.forEach(t=>p.factory.setParamValue(p.dspVoices$[i],t,0)),p.dspVoicesState[i]=p.kReleaseVoice,this.faust.log("keyOff voice "+i))},p.allNotesOff=()=>{p.cachedEvents.push({type:"ctrlChange",data:[0,123,0]});for(var t=function(t){p.fGateLabel$.forEach(e=>p.factory.setParamValue(p.dspVoices$[t],e,0)),p.dspVoicesState[t]=p.kReleaseVoice},e=0;e<p.voices;e++)t(e)}),p.midiMessage=t=>{p.cachedEvents.push({data:t,type:"midi"});var e=t[0]>>4,s=15&t[0],i=t[1],a=t[2];if(9!==s){if(p.voices){if(8===e||9===e&&0===a)return p.keyOff(s,i,a);if(9===e)return p.keyOn(s,i,a)}return 11===e?p.ctrlChange(s,i,a):14===e?p.pitchWheel(s,128*a+i):void 0}},p.ctrlChange=(t,e,s)=>{p.cachedEvents.push({type:"ctrlChange",data:[t,e,s]}),p.fCtrlLabel[e].length&&p.fCtrlLabel[e].forEach(t=>{var e=t.path;p.setParamValue(e,b(s,0,127,t.min,t.max)),p.outputHandler&&p.outputHandler(e,p.getParamValue(e))})},p.pitchWheel=(t,e)=>{p.cachedEvents.push({type:"pitchWheel",data:[t,e]}),p.fPitchwheelLabel.forEach(t=>{p.setParamValue(t.path,b(e,0,16383,t.min,t.max)),p.outputHandler&&p.outputHandler(t.path,p.getParamValue(t.path))})},p.compute=t=>{if(p.destroyed)return!1;for(var e=0;e<p.numIn;e++){var s=t.inputBuffer.getChannelData(e);p.dspInChannnels[e].set(s)}if(p.computeHandler&&p.computeHandler(p.bufferSize),p.voices){p.mixer.clearOutput(p.bufferSize,p.numOut,p.$outs);for(var i=0;i<p.voices;i++)p.factory.compute(p.dspVoices$[i],p.bufferSize,p.$ins,p.$mixing),p.mixer.mixVoice(p.bufferSize,p.numOut,p.$mixing,p.$outs);p.effect&&p.effect.compute(p.$effect,p.bufferSize,p.$outs,p.$outs)}else p.factory.compute(p.$dsp,p.bufferSize,p.$ins,p.$outs);p.updateOutputs();for(var a=new Array(p.numOut).fill(null).map(()=>new Float32Array(p.bufferSize)),r=0;r<p.numOut;r++){var o=t.outputBuffer.getChannelData(r),n=p.dspOutChannnels[r];o.set(n),a[r].set(n)}return p.plotHandler&&p.plotHandler(a,p.$buffer++,p.cachedEvents.length?p.cachedEvents:void 0),p.cachedEvents=[],!0},p.setup=()=>{if(this.faust.log("buffer_size "+p.bufferSize),p.onaudioprocess=p.compute,p.numIn>0){p.$ins=p.$$audioHeapInputs;for(var t=0;t<p.numIn;t++)p.HEAP32[(p.$ins>>2)+t]=p.$audioHeapInputs+p.bufferSize*p.sampleSize*t;for(var e=p.HEAP32.subarray(p.$ins>>2,p.$ins+p.numIn*p.ptrSize>>2),s=0;s<p.numIn;s++)p.dspInChannnels[s]=p.HEAPF32.subarray(e[s]>>2,e[s]+p.bufferSize*p.sampleSize>>2)}if(p.numOut>0){p.$outs=p.$$audioHeapOutputs,p.voices&&(p.$mixing=p.$$audioHeapMixing);for(var i=0;i<p.numOut;i++)p.HEAP32[(p.$outs>>2)+i]=p.$audioHeapOutputs+p.bufferSize*p.sampleSize*i,p.voices&&(p.HEAP32[(p.$mixing>>2)+i]=p.$audioHeapMixing+p.bufferSize*p.sampleSize*i);for(var a=p.HEAP32.subarray(p.$outs>>2,p.$outs+p.numOut*p.ptrSize>>2),o=0;o<p.numOut;o++)p.dspOutChannnels[o]=p.HEAPF32.subarray(a[o]>>2,a[o]+p.bufferSize*p.sampleSize>>2)}p.parseUI(p.dspMeta.ui),p.effect&&p.parseUI(p.effectMeta.ui),p.voices?(p.inputsItems.forEach(t=>{t.endsWith("/gate")?p.fGateLabel$.push(p.pathTable$[t]):t.endsWith("/freq")?p.fFreqLabel$.push(p.pathTable$[t]):t.endsWith("/gain")&&p.fGainLabel$.push(p.pathTable$[t])}),p.dspVoices$.forEach(t=>p.factory.init(t,r.sampleRate)),p.effect&&p.effect.init(p.$effect,r.sampleRate)):p.factory.init(p.$dsp,r.sampleRate)},p.getSampleRate=()=>r.sampleRate,p.getNumInputs=()=>p.numIn,p.getNumOutputs=()=>p.numOut,p.init=t=>{p.voices?p.dspVoices$.forEach(e=>p.factory.init(e,t)):p.factory.init(p.$dsp,t)},p.instanceInit=t=>{p.voices?p.dspVoices$.forEach(e=>p.factory.instanceInit(e,t)):p.factory.instanceInit(p.$dsp,t)},p.instanceConstants=t=>{p.voices?p.dspVoices$.forEach(e=>p.factory.instanceConstants(e,t)):p.factory.instanceConstants(p.$dsp,t)},p.instanceResetUserInterface=()=>{p.voices?p.dspVoices$.forEach(t=>p.factory.instanceResetUserInterface(t)):p.factory.instanceResetUserInterface(p.$dsp)},p.instanceClear=()=>{p.voices?p.dspVoices$.forEach(t=>p.factory.instanceClear(t)):p.factory.instanceClear(p.$dsp)},p.metadata=t=>p.dspMeta.meta?p.dspMeta.meta.forEach(e=>t.declare(Object.keys(e)[0],e[Object.keys(e)[0]])):void 0,p.setOutputParamHandler=t=>p.outputHandler=t,p.getOutputParamHandler=()=>p.outputHandler,p.setComputeHandler=t=>p.computeHandler=t,p.getComputeHandler=()=>p.computeHandler;var v=(t,e)=>{if("object"!=typeof t)return!1;if(t.address)return t.address===e;for(var s in t)if(v(t[s],e))return!0;return!1};return p.setParamValue=(t,e)=>{p.cachedEvents.push({type:"param",data:{path:t,value:e}}),p.voices?p.effect&&v(p.effectMeta.ui,t)?p.effect.setParamValue(p.$effect,p.pathTable$[t],e):p.dspVoices$.forEach(s=>p.factory.setParamValue(s,p.pathTable$[t],e)):p.factory.setParamValue(p.$dsp,p.pathTable$[t],e)},p.getParamValue=t=>p.voices?p.effect&&v(p.effectMeta.ui,t)?p.effect.getParamValue(p.$effect,p.pathTable$[t]):p.factory.getParamValue(p.dspVoices$[0],p.pathTable$[t]):p.factory.getParamValue(p.$dsp,p.pathTable$[t]),p.getParams=()=>p.inputsItems,p.getJSON=()=>{if(p.voices){var t=p.dspMeta,e=p.effectMeta,s=function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?A(Object(s),!0).forEach((function(e){a()(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):A(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({},t);return s.ui=e?[{type:"tgroup",label:"Sequencer",items:[{type:"vgroup",label:"Instrument",items:t.ui},{type:"vgroup",label:"Effect",items:e.ui}]}]:[{type:"tgroup",label:"Polyphonic",items:[{type:"vgroup",label:"Voices",items:t.ui}]}],JSON.stringify(s)}return JSON.stringify(p.dspMeta)},p.getUI=()=>{if(p.voices){var t=p.dspMeta,e=p.effectMeta;return e?[{type:"tgroup",label:"Sequencer",items:[{type:"vgroup",label:"Instrument",items:t.ui},{type:"vgroup",label:"Effect",items:e.ui}]}]:[{type:"tgroup",label:"Polyphonic",items:[{type:"vgroup",label:"Voices",items:t.ui}]}]}return p.dspMeta.ui},p.destroy=()=>{p.destroyed=!0,delete p.outputHandler,delete p.computeHandler,delete p.plotHandler},p.setup(),p}getNode(t){var e=this;return u()(o.a.mark((function s(){var i,a,r,n,u,h,p,c,l,f,m,b,v;return o.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(i=t.compiledDsp,a=t.audioCtx,r=t.bufferSize,n=t.voices,u=t.plotHandler,h=r||512,s.prev=2,f=y(n,i.dspMeta,i.effectMeta,h),m=g(n,f),!n){s.next=16;break}return b={imports:{print:console.log},memory:{memory:f}},l=new WebAssembly.Instance(d,b),s.prev=8,s.next=11,WebAssembly.instantiate(i.effectModule,m);case 11:c=s.sent,s.next=16;break;case 14:s.prev=14,s.t0=s.catch(8);case 16:return s.next=18,WebAssembly.instantiate(i.dspModule,m);case 18:v=s.sent,p=e.initNode(i,v,c,l,a,h,f,n,u),s.next=26;break;case 22:throw s.prev=22,s.t1=s.catch(2),e.faust.error("Faust "+i.shaKey+" cannot be loaded or compiled"),s.t1;case 26:return s.abrupt("return",p);case 27:case"end":return s.stop()}}),s,null,[[2,22],[8,14]])})))()}}var w=()=>{class t{}t.id=faustData.id,t.dspMeta=faustData.dspMeta,t.effectMeta=faustData.effectMeta;class e extends AudioWorkletProcessor{static parseUI(t,e,s){for(var i=0;i<t.length;i++)this.parseGroup(t[i],e,s)}static parseGroup(t,e,s){t.items&&this.parseItems(t.items,e,s)}static parseItems(t,e,s){for(var i=0;i<t.length;i++)s(t[i],e,s)}static parseItem(t,s,i){"vgroup"===t.type||"hgroup"===t.type||"tgroup"===t.type?e.parseItems(t.items,s,i):"hbargraph"===t.type||"vbargraph"===t.type||("vslider"===t.type||"hslider"===t.type||"nentry"===t.type?faustData.voices&&(t.address.endsWith("/gate")||t.address.endsWith("/freq")||t.address.endsWith("/gain"))||s.push({name:t.address,defaultValue:t.init||0,minValue:t.min||0,maxValue:t.max||0}):"button"!==t.type&&"checkbox"!==t.type||faustData.voices&&(t.address.endsWith("/gate")||t.address.endsWith("/freq")||t.address.endsWith("/gain"))||s.push({name:t.address,defaultValue:t.init||0,minValue:0,maxValue:1}))}static parseItem2(t,s,i){if("vgroup"===t.type||"hgroup"===t.type||"tgroup"===t.type)e.parseItems(t.items,s,i);else if("hbargraph"===t.type||"vbargraph"===t.type)s.outputsItems.push(t.address),s.pathTable$[t.address]=t.index;else if("vslider"===t.type||"hslider"===t.type||"button"===t.type||"checkbox"===t.type||"nentry"===t.type){if(s.inputsItems.push(t.address),s.pathTable$[t.address]=t.index,!t.meta)return;t.meta.forEach(e=>{var i=e.midi;if(i){var a=i.trim();if("pitchwheel"===a)s.fPitchwheelLabel.push({path:t.address,min:t.min,max:t.max});else{var r=a.match(/^ctrl\s(\d+)/);if(!r)return;s.fCtrlLabel[parseInt(r[1])].push({path:t.address,min:t.min,max:t.max})}}})}}static get parameterDescriptors(){var e=[];return this.parseUI(t.dspMeta.ui,e,this.parseItem),t.effectMeta&&this.parseUI(t.effectMeta.ui,e,this.parseItem),e}constructor(e){super(e),this.destroyed=void 0,this.dspInstance=void 0,this.effectInstance=void 0,this.mixerInstance=void 0,this.memory=void 0,this.bufferSize=void 0,this.voices=void 0,this.dspMeta=void 0,this.$ins=void 0,this.$outs=void 0,this.dspInChannnels=void 0,this.dspOutChannnels=void 0,this.fPitchwheelLabel=void 0,this.fCtrlLabel=void 0,this.numIn=void 0,this.numOut=void 0,this.ptrSize=void 0,this.sampleSize=void 0,this.outputsTimer=void 0,this.inputsItems=void 0,this.outputsItems=void 0,this.pathTable$=void 0,this.$audioHeap=void 0,this.$$audioHeapInputs=void 0,this.$$audioHeapOutputs=void 0,this.$audioHeapInputs=void 0,this.$audioHeapOutputs=void 0,this.$dsp=void 0,this.factory=void 0,this.HEAP=void 0,this.HEAP32=void 0,this.HEAPF32=void 0,this.effectMeta=void 0,this.$effect=void 0,this.$mixing=void 0,this.fFreqLabel$=void 0,this.fGateLabel$=void 0,this.fGainLabel$=void 0,this.fDate=void 0,this.$$audioHeapMixing=void 0,this.$audioHeapMixing=void 0,this.mixer=void 0,this.effect=void 0,this.dspVoices$=void 0,this.dspVoicesState=void 0,this.dspVoicesLevel=void 0,this.dspVoicesDate=void 0,this.kActiveVoice=void 0,this.kFreeVoice=void 0,this.kReleaseVoice=void 0,this.kNoVoice=void 0,this.$buffer=void 0,this.cachedEvents=void 0,this.outputHandler=void 0,this.computeHandler=void 0,this.handleMessage=t=>{var e=t.data;switch(this.cachedEvents.push({type:t.data.type,data:t.data.data}),e.type){case"midi":this.midiMessage(e.data);break;case"keyOn":this.keyOn(e.data[0],e.data[1],e.data[2]);break;case"keyOff":this.keyOff(e.data[0],e.data[1],e.data[2]);break;case"ctrlChange":this.ctrlChange(e.data[0],e.data[1],e.data[2]);break;case"pitchWheel":this.pitchWheel(e.data[0],e.data[1]);break;case"param":this.setParamValue(e.data.path,e.data.value);break;case"destroy":this.port.close(),this.destroyed=!0,delete this.outputHandler,delete this.computeHandler}};var s=e.processorOptions;if(this.instantiateWasm(s),this.port.onmessage=this.handleMessage,this.destroyed=!1,this.bufferSize=128,this.voices=s.voices,this.dspMeta=s.compiledDsp.dspMeta,this.outputHandler=(t,e)=>this.port.postMessage({path:t,value:e,type:"param"}),this.computeHandler=null,this.$ins=null,this.$outs=null,this.dspInChannnels=[],this.dspOutChannnels=[],this.fPitchwheelLabel=[],this.fCtrlLabel=new Array(128).fill(null).map(()=>[]),this.numIn=this.dspMeta.inputs,this.numOut=this.dspMeta.outputs,this.ptrSize=4,this.sampleSize=4,this.factory=this.dspInstance.exports,this.HEAP=this.voices?this.memory.buffer:this.factory.memory.buffer,this.HEAP32=new Int32Array(this.HEAP),this.HEAPF32=new Float32Array(this.HEAP),this.outputsTimer=5,this.outputsItems=[],this.inputsItems=[],this.$audioHeap=this.voices?0:this.dspMeta.size,this.$$audioHeapInputs=this.$audioHeap,this.$$audioHeapOutputs=this.$$audioHeapInputs+this.numIn*this.ptrSize,this.$audioHeapInputs=this.$$audioHeapOutputs+this.numOut*this.ptrSize,this.$audioHeapOutputs=this.$audioHeapInputs+this.numIn*this.bufferSize*this.sampleSize,this.voices?(this.$$audioHeapMixing=this.$$audioHeapOutputs+this.numOut*this.ptrSize,this.$audioHeapInputs=this.$$audioHeapMixing+this.numOut*this.ptrSize,this.$audioHeapOutputs=this.$audioHeapInputs+this.numIn*this.bufferSize*this.sampleSize,this.$audioHeapMixing=this.$audioHeapOutputs+this.numOut*this.bufferSize*this.sampleSize,this.$dsp=this.$audioHeapMixing+this.numOut*this.bufferSize*this.sampleSize):(this.$audioHeapInputs=this.$$audioHeapOutputs+this.numOut*this.ptrSize,this.$audioHeapOutputs=this.$audioHeapInputs+this.numIn*this.bufferSize*this.sampleSize,this.$dsp=0),this.voices){this.effectMeta=t.effectMeta,this.$mixing=null,this.fFreqLabel$=[],this.fGateLabel$=[],this.fGainLabel$=[],this.fDate=0,this.mixer=this.mixerInstance.exports,this.effect=this.effectInstance?this.effectInstance.exports:null,this.dspVoices$=[],this.dspVoicesState=[],this.dspVoicesLevel=[],this.dspVoicesDate=[],this.kActiveVoice=0,this.kFreeVoice=-1,this.kReleaseVoice=-2,this.kNoVoice=-3;for(var i=0;i<this.voices;i++)this.dspVoices$[i]=this.$dsp+i*this.dspMeta.size,this.dspVoicesState[i]=this.kFreeVoice,this.dspVoicesLevel[i]=0,this.dspVoicesDate[i]=0;this.$effect=this.dspVoices$[this.voices-1]+this.dspMeta.size}this.pathTable$={},this.$buffer=0,this.cachedEvents=[],this.setup()}instantiateWasm(t){var e=createWasmMemory(t.voices,t.compiledDsp.dspMeta,t.compiledDsp.effectMeta,128);this.memory=e;var s=createWasmImport(t.voices,e);if(this.dspInstance=new WebAssembly.Instance(t.compiledDsp.dspModule,s),t.compiledDsp.effectModule&&(this.effectInstance=new WebAssembly.Instance(t.compiledDsp.effectModule,s)),t.voices){var i={imports:{print:console.log},memory:{memory:e}};this.mixerInstance=new WebAssembly.Instance(t.mixer32Module,i)}}updateOutputs(){this.outputsItems.length>0&&this.outputHandler&&0==this.outputsTimer--&&(this.outputsTimer=5,this.outputsItems.forEach(t=>this.outputHandler(t,this.factory.getParamValue(this.$dsp,this.pathTable$[t]))))}parseUI(t){return e.parseUI(t,this,e.parseItem2)}parseGroup(t){return e.parseGroup(t,this,e.parseItem2)}parseItems(t){return e.parseItems(t,this,e.parseItem2)}parseItem(t){return e.parseItem2(t,this,e.parseItem2)}setParamValue(t,e){this.voices?this.effect&&findPath(this.effectMeta.ui,t)?this.effect.setParamValue(this.$effect,this.pathTable$[t],e):this.dspVoices$.forEach(s=>this.factory.setParamValue(s,this.pathTable$[t],e)):this.factory.setParamValue(this.$dsp,this.pathTable$[t],e)}getParamValue(t){return this.voices?this.effect&&findPath(this.effectMeta.ui,t)?this.effect.getParamValue(this.$effect,this.pathTable$[t]):this.factory.getParamValue(this.dspVoices$[0],this.pathTable$[t]):this.factory.getParamValue(this.$dsp,this.pathTable$[t])}setup(){if(this.numIn>0){this.$ins=this.$$audioHeapInputs;for(var t=0;t<this.numIn;t++)this.HEAP32[(this.$ins>>2)+t]=this.$audioHeapInputs+this.bufferSize*this.sampleSize*t;for(var e=this.HEAP32.subarray(this.$ins>>2,this.$ins+this.numIn*this.ptrSize>>2),s=0;s<this.numIn;s++)this.dspInChannnels[s]=this.HEAPF32.subarray(e[s]>>2,e[s]+this.bufferSize*this.sampleSize>>2)}if(this.numOut>0){this.$outs=this.$$audioHeapOutputs,this.voices&&(this.$mixing=this.$$audioHeapMixing);for(var i=0;i<this.numOut;i++)this.HEAP32[(this.$outs>>2)+i]=this.$audioHeapOutputs+this.bufferSize*this.sampleSize*i,this.voices&&(this.HEAP32[(this.$mixing>>2)+i]=this.$audioHeapMixing+this.bufferSize*this.sampleSize*i);for(var a=this.HEAP32.subarray(this.$outs>>2,this.$outs+this.numOut*this.ptrSize>>2),r=0;r<this.numOut;r++)this.dspOutChannnels[r]=this.HEAPF32.subarray(a[r]>>2,a[r]+this.bufferSize*this.sampleSize>>2)}this.parseUI(this.dspMeta.ui),this.effect&&this.parseUI(this.effectMeta.ui),this.voices?(this.inputsItems.forEach(t=>{t.endsWith("/gate")?this.fGateLabel$.push(this.pathTable$[t]):t.endsWith("/freq")?this.fFreqLabel$.push(this.pathTable$[t]):t.endsWith("/gain")&&this.fGainLabel$.push(this.pathTable$[t])}),this.dspVoices$.forEach(t=>this.factory.init(t,sampleRate)),this.effect&&this.effect.init(this.$effect,sampleRate)):this.factory.init(this.$dsp,sampleRate)}getPlayingVoice(t){if(!this.voices)return null;for(var e=this.kNoVoice,s=Number.MAX_VALUE,i=0;i<this.voices;i++)this.dspVoicesState[i]===t&&this.dspVoicesDate[i]<s&&(s=this.dspVoicesDate[i],e=i);return e}allocVoice(t){return this.voices?(this.factory.instanceClear(this.dspVoices$[t]),this.dspVoicesDate[t]=this.fDate++,this.dspVoicesState[t]=this.kActiveVoice,t):null}getFreeVoice(){if(!this.voices)return null;for(var t=0;t<this.voices;t++)if(this.dspVoicesState[t]===this.kFreeVoice)return this.allocVoice(t);for(var e=this.kNoVoice,s=this.kNoVoice,i=Number.MAX_VALUE,a=Number.MAX_VALUE,r=0;r<this.voices;r++)this.dspVoicesState[r]===this.kReleaseVoice?this.dspVoicesDate[r]<i&&(i=this.dspVoicesDate[r],e=r):this.dspVoicesDate[r]<a&&(a=this.dspVoicesDate[r],s=r);return i!==Number.MAX_VALUE?this.allocVoice(e):a!==Number.MAX_VALUE?this.allocVoice(s):this.kNoVoice}keyOn(t,e,s){if(this.voices){var i=this.getFreeVoice();this.fFreqLabel$.forEach(t=>this.factory.setParamValue(this.dspVoices$[i],t,midiToFreq(e))),this.fGateLabel$.forEach(t=>this.factory.setParamValue(this.dspVoices$[i],t,1)),this.fGainLabel$.forEach(t=>this.factory.setParamValue(this.dspVoices$[i],t,s/127)),this.dspVoicesState[i]=e}}keyOff(t,e,s){if(this.voices){var i=this.getPlayingVoice(e);i!==this.kNoVoice&&(this.fGateLabel$.forEach(t=>this.factory.setParamValue(this.dspVoices$[i],t,0)),this.dspVoicesState[i]=this.kReleaseVoice)}}allNotesOff(){var t=this;if(this.voices)for(var e=function(e){t.fGateLabel$.forEach(s=>t.factory.setParamValue(t.dspVoices$[e],s,0)),t.dspVoicesState[e]=t.kReleaseVoice},s=0;s<this.voices;s++)e(s)}midiMessage(t){var e=t[0]>>4,s=15&t[0],i=t[1],a=t[2];9!==s&&(8===e||9===e&&0===a?this.keyOff(s,i,a):9===e?this.keyOn(s,i,a):11===e?this.ctrlChange(s,i,a):14===e&&this.pitchWheel(s,128*a+i))}ctrlChange(t,e,s){this.fCtrlLabel[e].length&&this.fCtrlLabel[e].forEach(t=>{var e=t.path;this.setParamValue(e,remap(s,0,127,t.min,t.max)),this.outputHandler&&this.outputHandler(e,this.getParamValue(e))})}pitchWheel(t,e){this.fPitchwheelLabel.forEach(t=>{this.setParamValue(t.path,remap(e,0,16383,t.min,t.max)),this.outputHandler&&this.outputHandler(t.path,this.getParamValue(t.path))})}process(t,e,s){if(this.destroyed)return!1;var i=t[0],a=e[0];if(this.numIn>0&&(!i||!i[0]||0===i[0].length))return!0;if(this.numOut>0&&(!a||!a[0]||0===a[0].length))return!0;if(void 0!==i)for(var r=0;r<Math.min(this.numIn,i.length);++r){this.dspInChannnels[r].set(i[r])}for(var o in s){var n=s[o];this.setParamValue(o,n[0])}if(this.computeHandler&&this.computeHandler(this.bufferSize),this.voices){this.mixer.clearOutput(this.bufferSize,this.numOut,this.$outs);for(var u=0;u<this.voices;u++)this.factory.compute(this.dspVoices$[u],this.bufferSize,this.$ins,this.$mixing),this.mixer.mixVoice(this.bufferSize,this.numOut,this.$mixing,this.$outs);this.effect&&this.effect.compute(this.$effect,this.bufferSize,this.$outs,this.$outs)}else this.factory.compute(this.$dsp,this.bufferSize,this.$ins,this.$outs);if(this.updateOutputs(),void 0!==a){for(var h=0;h<Math.min(this.numOut,a.length);h++){var p=this.dspOutChannnels[h];a[h].set(p)}this.port.postMessage({type:"plot",value:a,index:this.$buffer++,events:this.cachedEvents}),this.cachedEvents=[]}return!0}printMemory(){console.log("============== Memory layout =============="),console.log("dspMeta.size: "+this.dspMeta.size),console.log("$audioHeap: "+this.$audioHeap),console.log("$$audioHeapInputs: "+this.$$audioHeapInputs),console.log("$$audioHeapOutputs: "+this.$$audioHeapOutputs),console.log("$$audioHeapMixing: "+this.$$audioHeapMixing),console.log("$audioHeapInputs: "+this.$audioHeapInputs),console.log("$audioHeapOutputs: "+this.$audioHeapOutputs),console.log("$audioHeapMixing: "+this.$audioHeapMixing),console.log("$dsp: "+this.$dsp),this.dspVoices$&&this.dspVoices$.forEach((t,e)=>console.log("dspVoices$["+e+"]: "+t)),console.log("$effect: "+this.$effect),console.log("$mixing: "+this.$mixing)}}e.bufferSize=128,registerProcessor(t.id||"mydsp",e)};function x(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}class O extends(window.AudioWorkletNode?AudioWorkletNode:null){constructor(t){super(t.audioCtx,t.id,{numberOfInputs:t.compiledDsp.dspMeta.inputs>0?1:0,numberOfOutputs:t.compiledDsp.dspMeta.outputs>0?1:0,channelCount:Math.max(1,t.compiledDsp.dspMeta.inputs),outputChannelCount:[t.compiledDsp.dspMeta.outputs],channelCountMode:"explicit",channelInterpretation:"speakers",processorOptions:{id:t.id,voices:t.voices,compiledDsp:t.compiledDsp,mixer32Module:t.mixer32Module}}),this.onprocessorerror=t=>{throw console.error("Error from "+this.dspMeta.name+" AudioWorkletNode: "),t.error},this.voices=void 0,this.dspMeta=void 0,this.effectMeta=void 0,this.outputHandler=void 0,this.inputsItems=void 0,this.outputsItems=void 0,this.fPitchwheelLabel=void 0,this.fCtrlLabel=void 0,this.plotHandler=void 0,this.port.onmessage=t=>{"param"===t.data.type&&this.outputHandler?this.outputHandler(t.data.path,t.data.value):"plot"===t.data.type&&this.plotHandler&&this.plotHandler(t.data.value,t.data.index,t.data.events)},this.voices=t.voices,this.dspMeta=t.compiledDsp.dspMeta,this.effectMeta=t.compiledDsp.effectMeta,this.outputHandler=null,this.inputsItems=[],this.outputsItems=[],this.fPitchwheelLabel=[],this.fCtrlLabel=new Array(128).fill(null).map(()=>[]),this.plotHandler=t.plotHandler,this.parseUI(this.dspMeta.ui),this.effectMeta&&this.parseUI(this.effectMeta.ui);try{this.parameters&&this.parameters.forEach(t=>t.automationRate="k-rate")}catch(t){}}parseUI(t){t.forEach(t=>this.parseGroup(t))}parseGroup(t){t.items&&this.parseItems(t.items)}parseItems(t){t.forEach(t=>this.parseItem(t))}parseItem(t){if("vgroup"===t.type||"hgroup"===t.type||"tgroup"===t.type)this.parseItems(t.items);else if("hbargraph"===t.type||"vbargraph"===t.type)this.outputsItems.push(t.address);else if("vslider"===t.type||"hslider"===t.type||"button"===t.type||"checkbox"===t.type||"nentry"===t.type){if(this.inputsItems.push(t.address),!t.meta)return;t.meta.forEach(e=>{var s=e.midi;if(s){var i=s.trim();if("pitchwheel"===i)this.fPitchwheelLabel.push({path:t.address,min:t.min,max:t.max});else{var a=i.match(/^ctrl\s(\d+)/);if(!a)return;this.fCtrlLabel[parseInt(a[1])].push({path:t.address,min:t.min,max:t.max})}}})}}keyOn(t,e,s){var i={type:"keyOn",data:[t,e,s]};this.port.postMessage(i)}keyOff(t,e,s){var i={type:"keyOff",data:[t,e,s]};this.port.postMessage(i)}allNotesOff(){this.port.postMessage({type:"ctrlChange",data:[0,123,0]})}ctrlChange(t,e,s){var i={type:"ctrlChange",data:[t,e,s]};this.port.postMessage(i),this.fCtrlLabel[e].length&&this.fCtrlLabel[e].forEach(t=>{var e=t.path,i=b(s,0,127,t.min,t.max),a=this.parameters.get(e);a&&a.setValueAtTime(i,this.context.currentTime)})}pitchWheel(t,e){var s={type:"pitchWheel",data:[t,e]};this.port.postMessage(s),this.fPitchwheelLabel.forEach(t=>{var s=t.path,i=b(e,0,16383,t.min,t.max),a=this.parameters.get(s);a&&a.setValueAtTime(i,this.context.currentTime)})}midiMessage(t){var e=t[0]>>4,s=15&t[0],i=t[1],a=t[2];9!==s&&(8===e||9===e&&0===a?this.keyOff(s,i,a):9===e?this.keyOn(s,i,a):11===e?this.ctrlChange(s,i,a):14===e?this.pitchWheel(s,128*a+i):this.port.postMessage({data:t,type:"midi"}))}metadata(){}setParamValue(t,e){var s={type:"param",data:{path:t,value:e}};this.port.postMessage(s);var i=this.parameters.get(t);i&&i.setValueAtTime(e,this.context.currentTime)}getParamValue(t){var e=this.parameters.get(t);return e?e.value:null}setOutputParamHandler(t){this.outputHandler=t}getOutputParamHandler(){return this.outputHandler}getNumInputs(){return this.dspMeta.inputs}getNumOutputs(){return this.dspMeta.outputs}getParams(){return this.inputsItems}getJSON(){if(this.voices){var t=this.dspMeta,e=this.effectMeta,s=function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?x(Object(s),!0).forEach((function(e){a()(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):x(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}({},t);return s.ui=e?[{type:"tgroup",label:"Sequencer",items:[{type:"vgroup",label:"Instrument",items:t.ui},{type:"vgroup",label:"Effect",items:e.ui}]}]:[{type:"tgroup",label:"Polyphonic",items:[{type:"vgroup",label:"Voices",items:t.ui}]}],JSON.stringify(s)}return JSON.stringify(this.dspMeta)}getUI(){if(this.voices){var t=this.dspMeta,e=this.effectMeta;return e?[{type:"tgroup",label:"Sequencer",items:[{type:"vgroup",label:"Instrument",items:t.ui},{type:"vgroup",label:"Effect",items:e.ui}]}]:[{type:"tgroup",label:"Polyphonic",items:[{type:"vgroup",label:"Voices",items:t.ui}]}]}return this.dspMeta.ui}destroy(){this.port.postMessage({type:"destroy"}),this.port.close(),delete this.plotHandler,delete this.outputHandler}}class S{constructor(){this.bufferSize=1024,this.sampleRate=void 0,this.dspMeta=void 0,this.$ins=void 0,this.$outs=void 0,this.dspInChannnels=void 0,this.dspOutChannnels=void 0,this.numIn=void 0,this.numOut=void 0,this.ptrSize=void 0,this.sampleSize=void 0,this.$audioHeap=void 0,this.$$audioHeapInputs=void 0,this.$$audioHeapOutputs=void 0,this.$audioHeapInputs=void 0,this.$audioHeapOutputs=void 0,this.$dsp=void 0,this.factory=void 0,this.HEAP=void 0,this.HEAP32=void 0,this.HEAPF32=void 0,this.output=void 0}static get importObject(){return{env:{memory:void 0,memoryBase:0,tableBase:0,_abs:Math.abs,_acosf:Math.acos,_asinf:Math.asin,_atanf:Math.atan,_atan2f:Math.atan2,_ceilf:Math.ceil,_cosf:Math.cos,_expf:Math.exp,_floorf:Math.floor,_fmodf:(t,e)=>t%e,_logf:Math.log,_log10f:Math.log10,_max_f:Math.max,_min_f:Math.min,_remainderf:(t,e)=>t-Math.round(t/e)*e,_powf:Math.pow,_roundf:Math.fround,_sinf:Math.sin,_sqrtf:Math.sqrt,_tanf:Math.tan,_acoshf:Math.acosh,_asinhf:Math.asinh,_atanhf:Math.atanh,_coshf:Math.cosh,_sinhf:Math.sinh,_tanhf:Math.tanh,_acos:Math.acos,_asin:Math.asin,_atan:Math.atan,_atan2:Math.atan2,_ceil:Math.ceil,_cos:Math.cos,_exp:Math.exp,_floor:Math.floor,_fmod:(t,e)=>t%e,_log:Math.log,_log10:Math.log10,_max_:Math.max,_min_:Math.min,_remainder:(t,e)=>t-Math.round(t/e)*e,_pow:Math.pow,_round:Math.fround,_sin:Math.sin,_sqrt:Math.sqrt,_tan:Math.tan,_acosh:Math.acosh,_asinh:Math.asinh,_atanh:Math.atanh,_cosh:Math.cosh,_sinh:Math.sinh,_tanh:Math.tanh,table:new WebAssembly.Table({initial:0,element:"anyfunc"})}}}init(t){var e=this;return u()(o.a.mark((function s(){var i,a;return o.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(i=t.compiledDsp){s.next=3;break}throw new Error("No Dsp input");case 3:return e.dspMeta=i.dspMeta,e.$ins=null,e.$outs=null,e.dspInChannnels=[],e.dspOutChannnels=[],e.numIn=e.dspMeta.inputs,e.numOut=e.dspMeta.outputs,e.ptrSize=4,e.sampleSize=4,s.next=14,WebAssembly.instantiate(i.dspModule,S.importObject);case 14:a=s.sent,e.factory=a.exports,e.HEAP=e.factory.memory.buffer,e.HEAP32=new Int32Array(e.HEAP),e.HEAPF32=new Float32Array(e.HEAP),e.output=new Array(e.numOut).fill(null).map(()=>new Float32Array(e.bufferSize));case 20:case"end":return s.stop()}}),s)})))()}setup(t){if(!this.dspMeta)throw new Error("No Dsp");if(this.sampleRate=t&&t.sampleRate||48e3,this.$audioHeap=this.dspMeta.size,this.$$audioHeapInputs=this.$audioHeap,this.$$audioHeapOutputs=this.$$audioHeapInputs+this.numIn*this.ptrSize,this.$audioHeapInputs=this.$$audioHeapOutputs+this.numOut*this.ptrSize,this.$audioHeapOutputs=this.$audioHeapInputs+this.numIn*this.bufferSize*this.sampleSize,this.$dsp=0,this.numIn>0){this.$ins=this.$$audioHeapInputs;for(var e=0;e<this.numIn;e++)this.HEAP32[(this.$ins>>2)+e]=this.$audioHeapInputs+this.bufferSize*this.sampleSize*e;for(var s=this.HEAP32.subarray(this.$ins>>2,this.$ins+this.numIn*this.ptrSize>>2),i=0;i<this.numIn;i++)this.dspInChannnels[i]=this.HEAPF32.subarray(s[i]>>2,s[i]+this.bufferSize*this.sampleSize>>2)}if(this.numOut>0){this.$outs=this.$$audioHeapOutputs;for(var a=0;a<this.numOut;a++)this.HEAP32[(this.$outs>>2)+a]=this.$audioHeapOutputs+this.bufferSize*this.sampleSize*a;for(var r=this.HEAP32.subarray(this.$outs>>2,this.$outs+this.numOut*this.ptrSize>>2),o=0;o<this.numOut;o++)this.dspOutChannnels[o]=this.HEAPF32.subarray(r[o]>>2,r[o]+this.bufferSize*this.sampleSize>>2)}this.factory.init(this.$dsp,this.sampleRate)}compute(){if(!this.factory)return this.output;for(var t=0;t<this.numIn;t++)this.dspInChannnels[t].fill(0);if(this.factory.compute(this.$dsp,this.bufferSize,this.$ins,this.$outs),void 0!==this.output)for(var e=0;e<this.numOut;e++)this.output[e].set(this.dspOutChannnels[e]);return this.output}plot(t){var e=this;return u()(o.a.mark((function s(){var i,a,r,n,u;return o.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(!t||!t.compiledDsp){s.next=3;break}return s.next=3,e.init(t);case 3:for(e.setup(t),i=t&&t.size||128,a=new Array(e.numOut).fill(null).map(()=>new Float32Array(i)),r=0;r<i;r+=e.bufferSize)for(n=e.compute(),u=0;u<a.length;u++)a[u].set(i-r>e.bufferSize?n[u]:n[u].subarray(0,i-r),r);return s.abrupt("return",a);case 8:case"end":return s.stop()}}),s)})))()}}function F(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,i)}return s}function H(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?F(Object(s),!0).forEach((function(e){a()(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):F(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}class I{constructor(t){this.libFaust=void 0,this.createWasmCDSPFactoryFromString=void 0,this.deleteAllWasmCDSPFactories=void 0,this.expandCDSPFromString=void 0,this.getCLibFaustVersion=void 0,this.getWasmCModule=void 0,this.getWasmCModuleSize=void 0,this.getWasmCHelpers=void 0,this.freeWasmCModule=void 0,this.freeCMemory=void 0,this.cleanupAfterException=void 0,this.getErrorAfterException=void 0,this.getLibFaustVersion=void 0,this.generateCAuxFilesFromString=void 0,this.debug=!1,this.dspTable={},this.workletProcessors=[],this._log=[],this.offlineProcessor=new S,this.jsLocation=void 0,this.wasmLocation=void 0,this.dataLocation=void 0,this.logHandler=void 0,this.debug=!(!t||!t.debug),this.jsLocation=t.jsLocation||"http://fr0stbyter.github.io/faust2webaudio/dist/libfaust-wasm.js",this.wasmLocation=t.wasmLocation||"http://fr0stbyter.github.io/faust2webaudio/dist/libfaust-wasm.wasm",this.dataLocation=t.dataLocation||"http://fr0stbyter.github.io/faust2webaudio/dist/libfaust-wasm.data"}loadLibFaust(){var t=this;return u()(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.libFaust){e.next=2;break}return e.abrupt("return",t);case 2:return e.next=4,c.load(t.jsLocation,t.wasmLocation,t.dataLocation);case 4:return t.libFaust=e.sent,t.importLibFaustFunctions(),e.abrupt("return",t);case 7:case"end":return e.stop()}}),e)})))()}get ready(){return this.loadLibFaust()}importLibFaustFunctions(){this.libFaust&&(this.createWasmCDSPFactoryFromString=this.libFaust.cwrap("createWasmCDSPFactoryFromString","number",["number","number","number","number","number","number"]),this.deleteAllWasmCDSPFactories=this.libFaust.cwrap("deleteAllWasmCDSPFactories",null,[]),this.expandCDSPFromString=this.libFaust.cwrap("expandCDSPFromString","number",["number","number","number","number","number","number"]),this.getCLibFaustVersion=this.libFaust.cwrap("getCLibFaustVersion","number",[]),this.getWasmCModule=this.libFaust.cwrap("getWasmCModule","number",["number"]),this.getWasmCModuleSize=this.libFaust.cwrap("getWasmCModuleSize","number",["number"]),this.getWasmCHelpers=this.libFaust.cwrap("getWasmCHelpers","number",["number"]),this.freeWasmCModule=this.libFaust.cwrap("freeWasmCModule",null,["number"]),this.freeCMemory=this.libFaust.cwrap("freeCMemory",null,["number"]),this.cleanupAfterException=this.libFaust.cwrap("cleanupAfterException",null,[]),this.getErrorAfterException=this.libFaust.cwrap("getErrorAfterException","number",[]),this.getLibFaustVersion=()=>this.libFaust.UTF8ToString(this.getCLibFaustVersion()),this.generateCAuxFilesFromString=this.libFaust.cwrap("generateCAuxFilesFromString","number",["number","number","number","number","number"]))}getNode(t,e){var s=this;return u()(o.a.mark((function i(){var a,r,n,u,h,p,c,l,f;return o.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a=e.audioCtx,r=e.voices,n=e.useWorklet,u=e.bufferSize,h=e.plotHandler,p=e.args,c=$(p),i.next=4,s.compileCodes(t,c,!r);case 4:if(l=i.sent){i.next=7;break}return i.abrupt("return",null);case 7:return f={compiledDsp:l,audioCtx:a,voices:r,plotHandler:h,bufferSize:n?128:u},i.abrupt("return",n?s.getAudioWorkletNode(f):s.getScriptProcessorNode(f));case 9:case"end":return i.stop()}}),i)})))()}inspect(t,e){var s=this;return u()(o.a.mark((function i(){var a,r,n;return o.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a=e.voices,r=e.args,n=$(r),i.abrupt("return",s.compileCodes(t,n,!a));case 3:case"end":return i.stop()}}),i)})))()}plot(t){var e=this;return u()(o.a.mark((function s(){var i,a;return o.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(a=$(t.args),!t.code){s.next=7;break}return s.next=4,e.compileCodes(t.code,a,!0);case 4:if(i=s.sent){s.next=7;break}return s.abrupt("return",null);case 7:return s.abrupt("return",e.offlineProcessor.plot(H({compiledDsp:i},t)));case 8:case"end":return s.stop()}}),s)})))()}compileCode(t,e,s,i){var a=this.libFaust.lengthBytesUTF8(e)+1,r=this.libFaust._malloc(a),o=this.libFaust.lengthBytesUTF8("FaustDSP")+1,n=this.libFaust._malloc(o),u=this.libFaust._malloc(4096);this.libFaust.stringToUTF8("FaustDSP",n,o),this.libFaust.stringToUTF8(e,r,a);var h=s||[];h.push("-cn",t);for(var p=this.libFaust._malloc(4*h.length),c=new Int32Array(this.libFaust.HEAP32.buffer,p,h.length),l=0;l<h.length;l++){var f=this.libFaust.lengthBytesUTF8(h[l])+1,d=this.libFaust._malloc(f);this.libFaust.stringToUTF8(h[l],d,f),c[l]=d}try{var m=performance.now(),b=this.createWasmCDSPFactoryFromString(n,r,h.length,p,u,i),v=performance.now();this.log("Faust compilation duration : "+(v-m));var g=this.libFaust.UTF8ToString(u);if(g)throw new Error(g);if(0===b)return null;for(var y=this.getWasmCModule(b),$=this.getWasmCModuleSize(b),A=new Uint8Array($),M=0;M<$;M++)A[M]=this.libFaust.HEAP8[y+M];var w=this.getWasmCHelpers(b),x=this.libFaust.UTF8ToString(w);this.libFaust._free(r),this.libFaust._free(n),this.libFaust._free(u),this.freeWasmCModule(b),c=new Int32Array(this.libFaust.HEAP32.buffer,p,h.length);for(var O=0;O<h.length;O++)this.libFaust._free(c[O]);return this.libFaust._free(p),{ui8Code:A,code:e,helpersCode:x}}catch(t){var S=this.libFaust.UTF8ToString(this.getErrorAfterException());throw this.cleanupAfterException(),S?new Error(S):t}}compileCodes(t,e,s){var i=this;return u()(o.a.mark((function a(){var r,n,u,h,c,l,f;return o.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(r=e.join(""),n=p.hash(t+(s?"internal_memory":"external_memory")+r,{msgFormat:"string"}),!(u=i.dspTable[n])){a.next=6;break}return i.log("Existing library : "+n),a.abrupt("return",u);case 6:i.log("libfaust.js version : "+i.getLibFaustVersion()),h="adapt(1,1) = _; adapt(2,2) = _,_; adapt(1,2) = _ <: _,_; adapt(2,1) = _,_ :> _;\nadaptor(F,G) = adapt(outputs(F),inputs(G));\ndsp_code = environment{".concat(t,"};\nprocess = adaptor(dsp_code.process, dsp_code.effect) : dsp_code.effect;"),c=i.compileCode(n,t,e,s);try{l=i.compileCode(n+"_",h,e,s)}catch(t){}return f={dsp:c,effect:l},a.abrupt("return",i.compileDsp(f,n));case 12:case"end":return a.stop()}}),a)})))()}expandCode(t,e){this.log("libfaust.js version : "+this.getLibFaustVersion());var s=this.libFaust.lengthBytesUTF8(t)+1,i=this.libFaust._malloc(s),a=this.libFaust.lengthBytesUTF8("FaustDSP")+1,r=this.libFaust._malloc(a),o=this.libFaust._malloc(64),n=this.libFaust._malloc(4096);this.libFaust.stringToUTF8("FaustDSP",r,a),this.libFaust.stringToUTF8(t,i,s);for(var u=[...e?$(e):[],"-lang","wasm"],h=this.libFaust._malloc(4*u.length),p=new Int32Array(this.libFaust.HEAP32.buffer,h,u.length),c=0;c<u.length;c++){var l=this.libFaust.lengthBytesUTF8(u[c])+1,f=this.libFaust._malloc(l);this.libFaust.stringToUTF8(u[c],f,l),p[c]=f}try{var d=this.expandCDSPFromString(r,i,u.length,h,o,n),m=this.libFaust.UTF8ToString(d),b=this.libFaust.UTF8ToString(n);b&&this.error(b),this.libFaust._free(i),this.libFaust._free(r),this.libFaust._free(o),this.libFaust._free(n),this.freeCMemory(d),p=new Int32Array(this.libFaust.HEAP32.buffer,h,u.length);for(var v=0;v<u.length;v++)this.libFaust._free(p[v]);return this.libFaust._free(h),m}catch(t){var g=this.libFaust.UTF8ToString(this.getErrorAfterException());throw this.cleanupAfterException(),g?new Error(g):t}}compileDsp(t,e){var s=this;return u()(o.a.mark((function i(){var a,r,n,u,h,p,c,l,f;return o.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a=performance.now(),i.next=3,WebAssembly.compile(t.dsp.ui8Code);case 3:if(r=i.sent){i.next=7;break}throw s.error("Faust DSP factory cannot be compiled"),new Error("Faust DSP factory cannot be compiled");case 7:n=performance.now(),s.log("WASM compilation duration : "+(n-a)),u={shaKey:e,codes:t,dspModule:r,dspMeta:void 0},i.prev=10,h=t.dsp.helpersCode.match(/getJSON\w+?\(\)[\s\n]*{[\s\n]*return[\s\n]*'(\{.+?)';}/)[1].replace(/\\'/g,"'"),p=JSON.parse(h),u.dspMeta=p,i.next=20;break;case 16:throw i.prev=16,i.t0=i.catch(10),s.error("Error in JSON.parse: "+i.t0.message),i.t0;case 20:if(s.dspTable[e]=u,t.effect){i.next=23;break}return i.abrupt("return",u);case 23:return i.prev=23,i.next=26,WebAssembly.compile(t.effect.ui8Code);case 26:c=i.sent,u.effectModule=c,i.prev=28,l=t.effect.helpersCode.match(/getJSON\w+?\(\)[\s\n]*{[\s\n]*return[\s\n]*'(\{.+?)';}/)[1].replace(/\\'/g,"'"),f=JSON.parse(l),u.effectMeta=f,i.next=38;break;case 34:throw i.prev=34,i.t1=i.catch(28),s.error("Error in JSON.parse: "+i.t1.message),i.t1;case 38:i.next=43;break;case 40:return i.prev=40,i.t2=i.catch(23),i.abrupt("return",u);case 43:return i.abrupt("return",u);case 44:case"end":return i.stop()}}),i,null,[[10,16],[23,40],[28,34]])})))()}getScriptProcessorNode(t){var e=this;return u()(o.a.mark((function s(){return o.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return s.abrupt("return",new M(e).getNode(t));case 1:case"end":return s.stop()}}),s)})))()}getAudioWorkletNode(t){var e=this;return u()(o.a.mark((function s(){var i,a,r,n,u,h,p,c;return o.a.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(i=t.compiledDsp,a=t.audioCtx,r=t.voices,n=t.plotHandler,delete(u=H({},i)).codes,h=u.shaKey+"_"+r,-1!==e.workletProcessors.indexOf(h)){s.next=10;break}return p="\nconst remap = ".concat(b.toString(),";\nconst midiToFreq = ").concat(m.toString(),";\nconst findPath = (").concat(v.toString(),")();\nconst createWasmImport = ").concat(g.toString(),";\nconst createWasmMemory = ").concat(y.toString(),";\nconst faustData = ").concat(JSON.stringify({id:h,voices:r,dspMeta:u.dspMeta,effectMeta:u.effectMeta}),";\n(").concat(w.toString(),")();\n"),c=window.URL.createObjectURL(new Blob([p],{type:"text/javascript"})),s.next=9,a.audioWorklet.addModule(c);case 9:e.workletProcessors.push(h);case 10:return s.abrupt("return",new O({audioCtx:a,id:h,voices:r,compiledDsp:u,plotHandler:n,mixer32Module:d}));case 11:case"end":return s.stop()}}),s)})))()}deleteDsp(t){delete this.dspTable[t.shaKey],this.deleteAllWasmCDSPFactories()}stringifyDspTable(){var t={};for(var e in this.dspTable){var s=this.dspTable[e].codes;t[e]={dsp:{strCode:btoa(l(s.dsp.ui8Code)),code:s.dsp.code,helpersCode:s.dsp.helpersCode},effect:s.effect?{strCode:btoa(l(s.effect.ui8Code)),code:s.effect.code,helpersCode:s.effect.helpersCode}:void 0}}return JSON.stringify(t)}parseDspTable(t){var e=this,s=JSON.parse(t),i=function(t){if(e.dspTable[t])return"continue";var i=s[t],a={dsp:{ui8Code:f(atob(i.dsp.strCode)),code:i.dsp.code,helpersCode:i.dsp.helpersCode},effect:i.effect?{ui8Code:f(atob(i.effect.strCode)),code:i.effect.code,helpersCode:i.effect.helpersCode}:void 0};e.compileDsp(a,t).then(s=>e.dspTable[t]=s)};for(var a in s)i(a)}getDiagram(t,e){var s=this.libFaust.lengthBytesUTF8(t)+1,i=this.libFaust._malloc(s),a=this.libFaust.lengthBytesUTF8("FaustDSP")+1,r=this.libFaust._malloc(a),o=this.libFaust._malloc(4096);this.libFaust.stringToUTF8("FaustDSP",r,a),this.libFaust.stringToUTF8(t,i,s);for(var n=[...e?$(e):[],"-lang","wast","-o","/dev/null","-svg"],u=this.libFaust._malloc(4*n.length),h=new Int32Array(this.libFaust.HEAP32.buffer,u,n.length),p=0;p<n.length;p++){var c=this.libFaust.lengthBytesUTF8(n[p])+1,l=this.libFaust._malloc(c);this.libFaust.stringToUTF8(n[p],l,c),h[p]=l}try{this.generateCAuxFilesFromString(r,i,n.length,u,o),this.libFaust._free(i),this.libFaust._free(r),this.libFaust._free(o),h=new Int32Array(this.libFaust.HEAP32.buffer,u,n.length);for(var f=0;f<n.length;f++)this.libFaust._free(h[f]);this.libFaust._free(u)}catch(t){var d=this.libFaust.UTF8ToString(this.getErrorAfterException());throw this.cleanupAfterException(),d?new Error(d):t}return this.libFaust.FS.readFile("FaustDSP-svg/process.svg",{encoding:"utf8"})}get fs(){return this.libFaust.FS}log(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.debug&&console.log(...e);var i=1===e.length&&"string"==typeof e[0]?e[0]:JSON.stringify(1!==e.length?e:e[0]);this._log.push(i),"function"==typeof this.logHandler&&this.logHandler(i,0)}error(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];console.error(...e);var i=1===e.length&&"string"==typeof e[0]?e[0]:JSON.stringify(1!==e.length?e:e[0]);this._log.push(i),"function"==typeof this.logHandler&&this.logHandler(i,1)}}s.d(e,"Faust",(function(){return I})),s.d(e,"FaustAudioWorkletNode",(function(){return O}))}])}));
//# sourceMappingURL=index.min.js.map